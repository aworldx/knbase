---
title: Garbage collection
keywords: ruby
summary: "This is just a sample topic..."
sidebar: knbase_sidebar
permalink: ruby_gc.html
folder: knbase
---

- используют С функции для аллокации памяти (malloc) и очистки (free)
- процесс работы GC в руби называется mark-and-sweep (пометить и подчистить)
- перед тем как начать работу GC останавливает программу. Это называется stop-the-world

### Mark and sweep
- сначала руби делает преаллокацию памяти для большого количества объектов и формирует free-list
- фаза mark: руби перебирает объекты, и помечает те, которые еще используются
- фаза sweep: снова перебирает объекты, очищает непомеченные, и возвращает их во free-list

### Tri-color mark-and-sweep
- делит объекты на три категории: белые, серые, черные
- белые объекты - непомеченные, потенциальные для вычищения
- серые объекты - помеченные, но имеющие ссылки на белые объекты
- черные объекты - помеченные, и не имеющие ссылки на белые объекты
- во время sweep фазы очищаются белые объекты

### Улучшения GC в разных версиях руби
- в версии 2.1 добавился generational garbage collection. Предполагается что в основном у объектов короткая жизнь. Поэтому выделяют young space и old space. Очистка young space запускается чаще и работает быстрее. Если объект "пережил" очистку в young space, то он перехоит в old space.
- в версии 2.2 появился incremental garbage collection. Запуск mark-and-sweep более часто, но при этом чтобы процесс занимал меньше времени.
- в версии 2.7 появился heap-compaction (дефрагментация области памяти)

### Альтернативные GC
- jemalloc
- TCmalloc

## Ссылки
- https://stackify.com/how-does-ruby-garbage-collection-work-a-simple-tutorial/